<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>App.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">tira</a> &gt; <a href="index.source.html" class="el_package">app</a> &gt; <span class="el_source">App.java</span></div><h1>App.java</h1><pre class="source lang-java linenums">package app;

import app.io.*;
import app.vector.Vector;
import app.fortune.*;
import app.parse.Parse;
import app.tree.*;

import java.util.ArrayList;
import java.util.List;
import java.util.Random;

import java.lang.StringBuilder;

import org.lwjgl.*;
import org.lwjgl.glfw.*;
import org.lwjgl.opengl.*;

import static org.lwjgl.glfw.Callbacks.*;
import static org.lwjgl.glfw.GLFW.*;
import static org.lwjgl.opengl.GL45.*;

public class App
{
	long window;
<span class="nc" id="L26">	int windowX = 720;</span>
<span class="nc" id="L27">	int windowY = 720;</span>
<span class="nc" id="L28">	boolean viewportChanged = true;</span>

<span class="nc" id="L30">	double cursorX = 0;</span>
<span class="nc" id="L31">	double cursorY = 0;</span>
<span class="nc" id="L32">	boolean cursorMoved = true;</span>
<span class="nc" id="L33">	boolean debug = false;</span>

<span class="nc" id="L35">	int numSites = 8;</span>
	List&lt;Vector&gt; sites;
	Fortune fortune;
<span class="nc" id="L38">	boolean regenerate = true;</span>
<span class="nc" id="L39">	boolean auto = true;</span>
<span class="nc" id="L40">	boolean next = false;</span>
<span class="nc" id="L41">	float zoomFactor = 1.0f;</span>
	float[] edges;
	float[] rays;
	float[] coords;
	float[] rayOrigins;
<span class="nc" id="L46">	Vector topLeft = screenPointToWorldPoint(new Vector(0, 0));</span>
<span class="nc" id="L47">	Vector bottomRight = screenPointToWorldPoint(new Vector(1, 1));</span>

	App()
<span class="nc" id="L50">	{</span>
		
<span class="nc" id="L52">	}</span>

	App(List&lt;Vector&gt; sites)
<span class="nc" id="L55">	{</span>
<span class="nc" id="L56">		this.sites = sites;</span>
<span class="nc" id="L57">		this.regenerate = false;</span>
<span class="nc" id="L58">		this.auto = false;</span>
<span class="nc" id="L59">		extractSiteCoords();</span>
<span class="nc" id="L60">		fortune = new Fortune(sites);</span>
<span class="nc" id="L61">	}</span>

	App(Vector[] arr)
<span class="nc" id="L64">	{</span>
<span class="nc" id="L65">		List&lt;Vector&gt; sites = new ArrayList&lt;&gt;();</span>
<span class="nc bnc" id="L66" title="All 2 branches missed.">		for (int i = 0; i &lt; arr.length; i++)</span>
<span class="nc" id="L67">			sites.add(arr[i]);</span>

<span class="nc" id="L69">		this.sites = sites;</span>
<span class="nc" id="L70">		this.regenerate = false;</span>
<span class="nc" id="L71">		this.auto = false;</span>
<span class="nc" id="L72">		extractSiteCoords();</span>
<span class="nc" id="L73">		fortune = new Fortune(sites);</span>
<span class="nc" id="L74">	}</span>

	public void run()
	{
<span class="nc" id="L78">		initWindow();</span>
<span class="nc" id="L79">		GL.createCapabilities();</span>
<span class="nc" id="L80">		initOpengl();</span>
<span class="nc" id="L81">		loop();</span>
<span class="nc" id="L82">	}</span>

	void saveDataset()
	{
<span class="nc" id="L86">		FileHandler.write(Parse.toStringl(sites), &quot;sites_&quot; + java.time.LocalDateTime.now().toString() + &quot;.txt&quot;);</span>
<span class="nc" id="L87">	}</span>

	void initWindow()
	{
<span class="nc" id="L91">		GLFWErrorCallback.createPrint(System.err).set();</span>

<span class="nc bnc" id="L93" title="All 2 branches missed.">		if (!glfwInit())</span>
<span class="nc" id="L94">			throw new RuntimeException(&quot;GLFW init failed&quot;);</span>

<span class="nc" id="L96">		glfwDefaultWindowHints();</span>

<span class="nc" id="L98">		window = glfwCreateWindow(windowX, windowY, &quot;Voronoi&quot;, 0, 0);</span>
<span class="nc bnc" id="L99" title="All 2 branches missed.">		if (window == 0)</span>
<span class="nc" id="L100">			throw new RuntimeException(&quot;GLFW Window creation failed&quot;);</span>

<span class="nc" id="L102">		glfwSetScrollCallback(window, (window, xoffset, yoffset) -&gt;</span>
		{
<span class="nc bnc" id="L104" title="All 2 branches missed.">			zoomFactor *= yoffset &lt; 0 ? 0.8f : 1.2f;</span>
<span class="nc" id="L105">			cursorMoved = true;</span>
<span class="nc" id="L106">		});</span>

<span class="nc" id="L108">		glfwSetKeyCallback(window, (window, key, scancode, action, mods) -&gt;</span>
		{
<span class="nc bnc" id="L110" title="All 4 branches missed.">			if (key == GLFW_KEY_ESCAPE &amp;&amp; action == GLFW_RELEASE)</span>
<span class="nc" id="L111">				glfwSetWindowShouldClose(window, true);</span>
<span class="nc bnc" id="L112" title="All 4 branches missed.">			if (key == GLFW_KEY_SPACE &amp;&amp; action == GLFW_RELEASE)</span>
			{
<span class="nc" id="L114">				cursorMoved = true;</span>
<span class="nc" id="L115">				regenerate = true;</span>
			}
<span class="nc bnc" id="L117" title="All 4 branches missed.">			if (key == GLFW_KEY_A &amp;&amp; action == GLFW_RELEASE)</span>
<span class="nc bnc" id="L118" title="All 2 branches missed.">				auto = !auto;</span>
<span class="nc bnc" id="L119" title="All 4 branches missed.">			if (key == GLFW_KEY_S &amp;&amp; action == GLFW_RELEASE)</span>
<span class="nc" id="L120">				saveDataset();</span>
<span class="nc bnc" id="L121" title="All 4 branches missed.">			if (key == GLFW_KEY_D &amp;&amp; action == GLFW_RELEASE)</span>
<span class="nc bnc" id="L122" title="All 2 branches missed.">				debug = !debug;</span>
<span class="nc bnc" id="L123" title="All 4 branches missed.">			if (key == GLFW_KEY_N &amp;&amp; action == GLFW_RELEASE)</span>
<span class="nc" id="L124">				next = true;</span>
<span class="nc bnc" id="L125" title="All 4 branches missed.">			if (key == GLFW_KEY_V &amp;&amp; action == GLFW_RELEASE)</span>
			{
				try
				{
<span class="nc bnc" id="L129" title="All 2 branches missed.">					if (new Validator(sites, new Fortune(sites).processAll()).result())</span>
<span class="nc" id="L130">						System.out.println(&quot;Ok result.&quot;);</span>
					else
<span class="nc" id="L132">						System.out.println(&quot;Invalid result.&quot;);</span>
				}
<span class="nc" id="L134">				catch (Exception e)</span>
				{
<span class="nc" id="L136">					System.out.println(&quot;Invalid result.&quot;);</span>
<span class="nc" id="L137">					System.out.println(e);</span>
<span class="nc" id="L138">					e.printStackTrace();</span>
<span class="nc" id="L139">				}</span>
			}
<span class="nc bnc" id="L141" title="All 4 branches missed.">			if (key == GLFW_KEY_1 &amp;&amp; action == GLFW_RELEASE)</span>
<span class="nc" id="L142">				numSites = 1;</span>
<span class="nc bnc" id="L143" title="All 4 branches missed.">			if (key == GLFW_KEY_2 &amp;&amp; action == GLFW_RELEASE)</span>
<span class="nc" id="L144">				numSites = 2;</span>
<span class="nc bnc" id="L145" title="All 4 branches missed.">			if (key == GLFW_KEY_3 &amp;&amp; action == GLFW_RELEASE)</span>
<span class="nc" id="L146">				numSites = 3;</span>
<span class="nc bnc" id="L147" title="All 4 branches missed.">			if (key == GLFW_KEY_4 &amp;&amp; action == GLFW_RELEASE)</span>
<span class="nc" id="L148">				numSites = 4;</span>
<span class="nc bnc" id="L149" title="All 4 branches missed.">			if (key == GLFW_KEY_5 &amp;&amp; action == GLFW_RELEASE)</span>
<span class="nc" id="L150">				numSites = 5;</span>
<span class="nc bnc" id="L151" title="All 4 branches missed.">			if (key == GLFW_KEY_6 &amp;&amp; action == GLFW_RELEASE)</span>
<span class="nc" id="L152">				numSites = 6;</span>
<span class="nc bnc" id="L153" title="All 4 branches missed.">			if (key == GLFW_KEY_7 &amp;&amp; action == GLFW_RELEASE)</span>
<span class="nc" id="L154">				numSites = 7;</span>
<span class="nc bnc" id="L155" title="All 4 branches missed.">			if (key == GLFW_KEY_8 &amp;&amp; action == GLFW_RELEASE)</span>
<span class="nc" id="L156">				numSites = 8;</span>
<span class="nc bnc" id="L157" title="All 4 branches missed.">			if (key == GLFW_KEY_9 &amp;&amp; action == GLFW_RELEASE)</span>
<span class="nc" id="L158">				numSites = 9;</span>
<span class="nc bnc" id="L159" title="All 4 branches missed.">			if (key == GLFW_KEY_0 &amp;&amp; action == GLFW_RELEASE)</span>
<span class="nc" id="L160">				numSites = 10;</span>
<span class="nc" id="L161">		});</span>

<span class="nc" id="L163">		glfwSetCursorPosCallback(window, (window, x, y) -&gt;</span>
		{
<span class="nc bnc" id="L165" title="All 2 branches missed.">			if (auto) return;</span>
<span class="nc" id="L166">			cursorX = x;</span>
<span class="nc" id="L167">			cursorY = y;</span>
<span class="nc" id="L168">			cursorMoved = true;</span>
<span class="nc" id="L169">		});</span>

<span class="nc" id="L171">		glfwSetWindowSizeCallback(window, (window, width, height) -&gt;</span>
		{
<span class="nc" id="L173">			windowX = width;</span>
<span class="nc" id="L174">			windowY = height;</span>
<span class="nc" id="L175">			viewportChanged = true;</span>
<span class="nc" id="L176">		});</span>

<span class="nc" id="L178">		glfwMakeContextCurrent(window);</span>
<span class="nc" id="L179">		glfwSwapInterval(1);</span>
<span class="nc" id="L180">		glfwShowWindow(window);</span>
<span class="nc" id="L181">	}</span>

	int createShader(int type, String code)
	{
<span class="nc" id="L185">		int shader = glCreateShader(type);</span>
<span class="nc bnc" id="L186" title="All 2 branches missed.">		if (shader == 0)</span>
<span class="nc" id="L187">			throw new RuntimeException(&quot;Shader creation failed&quot;);</span>

<span class="nc" id="L189">		glShaderSource(shader, code);</span>
<span class="nc" id="L190">		glCompileShader(shader);</span>

<span class="nc bnc" id="L192" title="All 2 branches missed.">		if (glGetShaderi(shader, GL_COMPILE_STATUS) == GL_FALSE)</span>
<span class="nc" id="L193">			throw new RuntimeException(&quot;Shader compilation failed: &quot;</span>
<span class="nc" id="L194">				+ glGetShaderInfoLog(shader, 512));</span>

<span class="nc" id="L196">		return shader;</span>
	}

	void initOpengl()
	{
<span class="nc" id="L201">		String str = FileHandler.readToString(&quot;src/shader/shader.vert&quot;);</span>
<span class="nc" id="L202">		int vertexShader = createShader(GL_VERTEX_SHADER, str);</span>
<span class="nc" id="L203">		str = FileHandler.readToString(&quot;src/shader/shader.frag&quot;);</span>
<span class="nc" id="L204">		int fragShader = createShader(GL_FRAGMENT_SHADER, str);</span>

<span class="nc" id="L206">		int prog = glCreateProgram();</span>
<span class="nc" id="L207">		glAttachShader(prog, vertexShader);</span>
<span class="nc" id="L208">		glAttachShader(prog, fragShader);</span>
<span class="nc" id="L209">		glLinkProgram(prog);</span>

<span class="nc bnc" id="L211" title="All 2 branches missed.">		if (glGetProgrami(prog, GL_LINK_STATUS) == GL_FALSE)</span>
<span class="nc" id="L212">			throw new RuntimeException(&quot;Program linking failed&quot;);</span>

<span class="nc" id="L214">		glUseProgram(prog);</span>

<span class="nc" id="L216">		int buffer = glGenBuffers();</span>
<span class="nc" id="L217">		glBindBuffer(GL_ARRAY_BUFFER, buffer);</span>

<span class="nc" id="L219">		glVertexAttribPointer(0, 2, GL_FLOAT, false, 0, 0);</span>
<span class="nc" id="L220">		glEnableVertexAttribArray(0);</span>

<span class="nc" id="L222">		glClearColor(1.0f, 1.0f, 1.0f, 0.0f);</span>

<span class="nc" id="L224">		glEnable(GL_PROGRAM_POINT_SIZE);</span>
<span class="nc" id="L225">		glEnable(GL_BLEND);</span>
<span class="nc" id="L226">		glBlendFunc(GL_SRC_ALPHA, GL_ONE_MINUS_SRC_ALPHA);</span>

<span class="nc" id="L228">		glDisable(GL_DEPTH_TEST);</span>
<span class="nc" id="L229">		glDisable(GL_SCISSOR_TEST);</span>
<span class="nc" id="L230">	}</span>

	void setColor(float r, float g, float b, float a)
	{
<span class="nc" id="L234">		glUniform4f(0, r, g, b, a);</span>
<span class="nc" id="L235">	}</span>

	void setZoomFactor(float z)
	{
<span class="nc" id="L239">		glUniform1f(1, z);</span>
<span class="nc" id="L240">	}</span>

	void drawPoints(float[] coords)
	{
<span class="nc" id="L244">		glBufferData(GL_ARRAY_BUFFER, coords, GL_DYNAMIC_DRAW);</span>
<span class="nc" id="L245">		glDrawArrays(GL_POINTS, 0, coords.length / 2);</span>
<span class="nc" id="L246">	}</span>

	void drawLines(float[] coords)
	{
<span class="nc" id="L250">		glBufferData(GL_ARRAY_BUFFER, coords, GL_DYNAMIC_DRAW);</span>
<span class="nc" id="L251">		glDrawArrays(GL_LINES, 0, coords.length / 2);</span>
<span class="nc" id="L252">	}</span>

	void drawParabola(Vector focus, double directrix, double xMin, double xMax)
	{
<span class="nc" id="L256">		double inc = 2.0 / windowX * (bottomRight.x - topLeft.x);</span>
<span class="nc" id="L257">		float[] coords = new float[</span>
<span class="nc" id="L258">			4 * ((int) Math.ceil(Math.abs(xMax - xMin) / inc) + 1)</span>
		];
<span class="nc" id="L260">		int i = 0;</span>

<span class="nc bnc" id="L262" title="All 2 branches missed.">		while (xMin &lt; xMax)</span>
		{
			double x1, x2, y1, y2;
<span class="nc" id="L265">			x1 = xMin;</span>
<span class="nc" id="L266">			x2 = Math.min(x1 + inc, xMax);</span>
<span class="nc" id="L267">			y1 = Utils.parabolaY(focus, directrix, x1);</span>
<span class="nc" id="L268">			y2 = Utils.parabolaY(focus, directrix, x2);</span>

<span class="nc" id="L270">			coords[i * 4 + 0] = (float) x1;</span>
<span class="nc" id="L271">			coords[i * 4 + 1] = (float) y1;</span>

<span class="nc" id="L273">			coords[i * 4 + 2] = (float) x2;</span>
<span class="nc" id="L274">			coords[i * 4 + 3] = (float) y2;</span>

<span class="nc" id="L276">			xMin += inc;</span>
<span class="nc" id="L277">			i++;</span>
<span class="nc" id="L278">		}</span>

<span class="nc" id="L280">		drawLines(coords);</span>
<span class="nc" id="L281">	}</span>

	static List&lt;Vector&gt; genSites(int count)
	{
<span class="nc" id="L285">		Random rand = new Random();</span>
<span class="nc" id="L286">		List&lt;Vector&gt; ret = new ArrayList&lt;&gt;();</span>
<span class="nc bnc" id="L287" title="All 2 branches missed.">		while (count-- &gt; 0)</span>
<span class="nc" id="L288">			ret.add(new Vector(</span>
<span class="nc" id="L289">				rand.nextDouble() * 0.9f + 0.05f,</span>
<span class="nc" id="L290">				rand.nextDouble() * 0.9f + 0.05f</span>
			));

<span class="nc" id="L293">		return ret;</span>
	}

	void extractSiteCoords()
	{
<span class="nc" id="L298">		int i = 0;</span>
<span class="nc" id="L299">		coords = new float[sites.size() * 2];</span>
<span class="nc bnc" id="L300" title="All 2 branches missed.">		for (Vector site : sites)</span>
		{
<span class="nc" id="L302">			coords[i * 2] = (float) site.x;</span>
<span class="nc" id="L303">			coords[i * 2 + 1] = (float) site.y;</span>
<span class="nc" id="L304">			i++;</span>
<span class="nc" id="L305">		}</span>

		try
		{
<span class="nc" id="L309">			Validator valid = new Validator(sites, new Fortune(sites).processAll());</span>
<span class="nc bnc" id="L310" title="All 2 branches missed.">			if (!valid.result())</span>
<span class="nc" id="L311">				System.out.println(&quot;Incorrect voronoi diagram generated from dataset.&quot;);</span>
		}
<span class="nc" id="L313">		catch (Error e)</span>
		{
<span class="nc" id="L315">			System.out.println(&quot;Error processing the generated list of sites.&quot;);</span>
<span class="nc" id="L316">			System.out.println(e);</span>
<span class="nc" id="L317">			e.printStackTrace();</span>
<span class="nc" id="L318">		}</span>
<span class="nc" id="L319">	}</span>

	void print(String s)
	{
<span class="nc bnc" id="L323" title="All 2 branches missed.">		if (debug)</span>
<span class="nc" id="L324">			System.out.println(s);</span>
<span class="nc" id="L325">	}</span>

	void drawQueuedCircleEvents()
	{
<span class="nc" id="L329">		fortune.queue.forEach(e -&gt;</span>
		{
<span class="nc bnc" id="L331" title="All 2 branches missed.">			if (!e.isSiteEvent())</span>
<span class="nc" id="L332">				drawPoints(new float[] {(float) e.point().x, (float) e.point().y});</span>
<span class="nc" id="L333">		});</span>
<span class="nc" id="L334">	}</span>

	void drawBeachline()
	{
<span class="nc" id="L338">		double inc = 2.0 / windowX * (bottomRight.x - topLeft.x);</span>
<span class="nc" id="L339">		List&lt;Vector&gt; coords = new ArrayList&lt;&gt;();</span>
<span class="nc" id="L340">		List&lt;Arc&gt; arcs = new ArrayList&lt;&gt;();</span>
<span class="nc" id="L341">		fortune.beach.forEach(v -&gt; arcs.add((Arc) v));</span>

<span class="nc" id="L343">		double x = topLeft.x;</span>
<span class="nc bnc" id="L344" title="All 2 branches missed.">		for (Arc arc : arcs)</span>
		{
<span class="nc" id="L346">			x = Math.min(x, Math.max(arc.left(fortune.sweepLine()).x, topLeft.x));</span>
<span class="nc" id="L347">			double limit = arc.right(fortune.sweepLine()).x;</span>
<span class="nc" id="L348">			limit = Math.min(limit, bottomRight.x);</span>
<span class="nc bnc" id="L349" title="All 2 branches missed.">			while (x &lt; limit)</span>
			{
<span class="nc" id="L351">				Vector a = Utils.parabolaPt(arc.site, fortune.sweepLine(), x);</span>
<span class="nc" id="L352">				Vector b = Utils.parabolaPt(arc.site, fortune.sweepLine(), Math.min(x + inc, limit));</span>
<span class="nc" id="L353">				coords.add(a);</span>
<span class="nc" id="L354">				coords.add(b);</span>
<span class="nc" id="L355">				x += inc;</span>
<span class="nc" id="L356">			}</span>
<span class="nc" id="L357">		}</span>

<span class="nc" id="L359">		float[] arr = new float[coords.size() * 2];</span>
<span class="nc" id="L360">		int i = 0;</span>
<span class="nc bnc" id="L361" title="All 2 branches missed.">		for (Vector point : coords)</span>
		{
<span class="nc" id="L363">			arr[i * 2 + 0] = (float) point.x;</span>
<span class="nc" id="L364">			arr[i * 2 + 1] = (float) point.y;</span>
<span class="nc" id="L365">			i++;</span>
<span class="nc" id="L366">		}</span>

<span class="nc" id="L368">		drawLines(arr);</span>
<span class="nc" id="L369">	}</span>

	void drawAllParabolas()
	{
<span class="nc bnc" id="L373" title="All 2 branches missed.">		for (Vector site : sites)</span>
		{
<span class="nc bnc" id="L375" title="All 2 branches missed.">			if (Math.abs(site.y - fortune.sweepLine()) &lt; Vector.PRECISION</span>
<span class="nc bnc" id="L376" title="All 2 branches missed.">				|| site.y &lt; fortune.sweepLine())</span>
<span class="nc" id="L377">				continue;</span>

<span class="nc" id="L379">			drawParabola(site, fortune.sweepLine(), topLeft.x, bottomRight.x);</span>
<span class="nc" id="L380">		}</span>
<span class="nc" id="L381">	}</span>

	void drawBeachlineVerticals()
	{
<span class="nc" id="L385">		fortune.beach.forEach(v -&gt;</span>
		{
<span class="nc" id="L387">			Arc arc = (Arc) v;</span>
<span class="nc" id="L388">			float xMin = (float) arc.left(fortune.sweepLine()).x;</span>

<span class="nc bnc" id="L390" title="All 2 branches missed.">			if (xMin == Double.NEGATIVE_INFINITY)</span>
<span class="nc" id="L391">				xMin = 0;</span>

<span class="nc" id="L393">			drawLines(new float[] {xMin, (float) topLeft.y, xMin, (float) bottomRight.y});</span>
<span class="nc" id="L394">		});</span>
<span class="nc" id="L395">	}</span>

	void drawBoundaries()
	{
<span class="nc" id="L399">		fortune.beach.forEach(v -&gt;</span>
		{
<span class="nc" id="L401">			Arc arc = (Arc) v;</span>
<span class="nc bnc" id="L402" title="All 2 branches missed.">			if (arc.left == null)</span>
<span class="nc" id="L403">				return;</span>

<span class="nc" id="L405">			Vector origin = arc.left.ray.origin;</span>
<span class="nc" id="L406">			Vector direction = arc.left.ray.direction.normalize();</span>
			float x1, x2, y1, y2;
<span class="nc" id="L408">			x1 = (float) origin.x;</span>
<span class="nc" id="L409">			x2 = x1 + (float) direction.x * 100;</span>
<span class="nc" id="L410">			y1 = (float) origin.y;</span>
<span class="nc" id="L411">			y2 = y1 + (float) direction.y * 100;</span>

<span class="nc" id="L413">			drawLines(new float[]{x1, y1, x2, y2});</span>
<span class="nc" id="L414">		});</span>
<span class="nc" id="L415">	}</span>

	Fortune.Result processResult()
	{
<span class="nc" id="L419">		int i = 0;</span>
<span class="nc" id="L420">		Fortune.Result result = fortune.result();</span>

<span class="nc" id="L422">		edges = new float[result.edges.size() * 4];</span>

<span class="nc bnc" id="L424" title="All 2 branches missed.">		for (Fortune.Edge edge : result.edges)</span>
		{
<span class="nc" id="L426">			Vector a = edge.a;</span>
<span class="nc" id="L427">			Vector b = edge.b;</span>
<span class="nc" id="L428">			edges[i * 4 + 0] = (float) a.x;</span>
<span class="nc" id="L429">			edges[i * 4 + 1] = (float) a.y;</span>

<span class="nc" id="L431">			edges[i * 4 + 2] = (float) b.x;</span>
<span class="nc" id="L432">			edges[i * 4 + 3] = (float) b.y;</span>
<span class="nc" id="L433">			i++;</span>
<span class="nc" id="L434">		}</span>

<span class="nc" id="L436">		rays = new float[result.rays.size() * 4];</span>

<span class="nc" id="L438">		i = 0;</span>
<span class="nc bnc" id="L439" title="All 2 branches missed.">		for (Fortune.Edge edge : result.rays)</span>
		{
<span class="nc" id="L441">			Vector a = edge.a;</span>
<span class="nc" id="L442">			Vector b = edge.b;</span>
<span class="nc" id="L443">			rays[i * 4 + 0] = (float) a.x;</span>
<span class="nc" id="L444">			rays[i * 4 + 1] = (float) a.y;</span>

<span class="nc" id="L446">			b = b.normalize().scale(100).add(a);</span>
<span class="nc" id="L447">			rays[i * 4 + 2] = (float) b.x;</span>
<span class="nc" id="L448">			rays[i * 4 + 3] = (float) b.y;</span>
<span class="nc" id="L449">			i++;</span>
<span class="nc" id="L450">		}</span>

<span class="nc" id="L452">		rayOrigins = new float[result.rays.size() * 2];</span>
<span class="nc" id="L453">		i = 0;</span>
<span class="nc bnc" id="L454" title="All 2 branches missed.">		for (Fortune.Edge edge : result.rays)</span>
		{
<span class="nc" id="L456">			Vector a = edge.a;</span>
<span class="nc" id="L457">			rayOrigins[i * 2 + 0] = (float) a.x;</span>
<span class="nc" id="L458">			rayOrigins[i * 2 + 1] = (float) a.y;</span>
<span class="nc" id="L459">		}</span>

<span class="nc" id="L461">		return result;</span>
	}

	Vector screenPointToWorldPoint(Vector p)
	{
<span class="nc" id="L466">		return p.sub(new Vector(0.5f, 0.5f))</span>
<span class="nc" id="L467">			.scale(1.0f / zoomFactor)</span>
<span class="nc" id="L468">			.add(new Vector(0.5f, 0.5f));</span>
	}

	void printInfo()
	{
<span class="nc" id="L473">		processResult();</span>
<span class="nc" id="L474">		fortune.beach.forEach(v -&gt;</span>
		{
<span class="nc" id="L476">			Arc arc = (Arc) v;</span>
<span class="nc" id="L477">			print(&quot;[&quot; + arc.left(fortune.sweepLine()).x</span>
				+ &quot;, &quot;
<span class="nc" id="L479">				+ arc.right(fortune.sweepLine()).x</span>
				+ &quot;]: &quot; + arc.site);
<span class="nc" id="L481">		});</span>
<span class="nc" id="L482">		print(&quot;Queue size: &quot; + fortune.queue.size());</span>
<span class="nc" id="L483">		print(&quot;Beachline size: &quot; + fortune.beach.size());</span>
<span class="nc" id="L484">	}</span>

	void loop()
	{
<span class="nc" id="L488">		double cursorPos = 0;</span>

<span class="nc bnc" id="L490" title="All 2 branches missed.">		while (!glfwWindowShouldClose(window))</span>
		{
<span class="nc" id="L492">			topLeft = screenPointToWorldPoint(new Vector(0, 0));</span>
<span class="nc" id="L493">			bottomRight = screenPointToWorldPoint(new Vector(1, 1));</span>
<span class="nc bnc" id="L494" title="All 2 branches missed.">			if (viewportChanged)</span>
			{
<span class="nc" id="L496">				viewportChanged = false;</span>
<span class="nc" id="L497">				glViewport(0, 0, windowX, windowY);</span>
			}

<span class="nc bnc" id="L500" title="All 2 branches missed.">			if (regenerate)</span>
			{
<span class="nc" id="L502">				regenerate = false;</span>
<span class="nc" id="L503">				sites = genSites(numSites);</span>
<span class="nc" id="L504">				extractSiteCoords();</span>
<span class="nc" id="L505">				fortune = new Fortune(sites);</span>
			}

<span class="nc bnc" id="L508" title="All 2 branches missed.">			if (next)</span>
			{
<span class="nc" id="L510">				next = false;</span>
<span class="nc" id="L511">				cursorMoved = false;</span>
				try
				{
<span class="nc" id="L514">					fortune.process();</span>
				}
<span class="nc" id="L516">				catch (Error e)</span>
				{
<span class="nc" id="L518">					print(e.toString());</span>
<span class="nc" id="L519">					e.printStackTrace();</span>
<span class="nc" id="L520">				}</span>
<span class="nc" id="L521">				processResult();</span>
<span class="nc" id="L522">				printInfo();</span>
			}

<span class="nc bnc" id="L525" title="All 2 branches missed.">			if (auto)</span>
			{
<span class="nc" id="L527">				cursorMoved = true;</span>
<span class="nc" id="L528">				cursorY += 2.0f;</span>
			}

<span class="nc" id="L531">			fortune.debug = debug;</span>
<span class="nc bnc" id="L532" title="All 2 branches missed.">			if (cursorMoved)</span>
			{
<span class="nc" id="L534">				cursorMoved = false;</span>
<span class="nc" id="L535">				Vector cPos = screenPointToWorldPoint(</span>
					new Vector(cursorX / windowX, 1.0 - cursorY / windowY)
				);

<span class="nc bnc" id="L539" title="All 2 branches missed.">				if (cPos.y &gt; cursorPos)</span>
<span class="nc" id="L540">					fortune = new Fortune(sites);</span>

<span class="nc" id="L542">				cursorPos = cPos.y;</span>

				try
				{
<span class="nc" id="L546">					fortune.processTo(cursorPos);</span>
				}
<span class="nc" id="L548">				catch (Error e)</span>
				{
<span class="nc" id="L550">					print(e.toString());</span>
<span class="nc" id="L551">					e.printStackTrace();</span>
<span class="nc" id="L552">				}</span>
<span class="nc" id="L553">				processResult();</span>
<span class="nc" id="L554">				printInfo();</span>
			}

<span class="nc bnc" id="L557" title="All 6 branches missed.">			if (auto &amp;&amp; fortune.peek() == null || cursorY &gt;= 2 * windowY)</span>
			{
<span class="nc" id="L559">				regenerate = true;</span>
<span class="nc" id="L560">				cursorY = -2.0f;</span>
			}

<span class="nc" id="L563">			glClear(GL_COLOR_BUFFER_BIT);</span>
<span class="nc" id="L564">			setZoomFactor(zoomFactor);</span>

<span class="nc" id="L566">			setColor(0.0f, 0.0f, 0.0f, 1.0f);</span>
<span class="nc" id="L567">			drawLines(new float[] {(float) topLeft.x, (float) cursorPos, (float) bottomRight.x, (float) cursorPos});</span>

<span class="nc" id="L569">			setColor(1.0f, 0.0f, 0.0f, 1.0f);</span>
<span class="nc" id="L570">			drawBeachline();</span>

			// setColor(1.0f, 0.0f, 0.0f, 0.2f);
			// drawAllParabolas();

			// setColor(0.0f, 0.0f, 0.0f, 0.1f);
			// drawBeachlineVerticals();

<span class="nc" id="L578">			setColor(1.0f, 0.0f, 0.0f, 1.0f);</span>
<span class="nc" id="L579">			drawPoints(coords);</span>

<span class="nc" id="L581">			setColor(0.0f, 0.0f, 1.0f, 1.0f);</span>
<span class="nc" id="L582">			drawQueuedCircleEvents();</span>

<span class="nc" id="L584">			setColor(0.0f, 0.0f, 0.0f, 1.0f);</span>
<span class="nc" id="L585">			drawLines(edges);</span>

<span class="nc" id="L587">			setColor(0.0f, 0.0f, 0.0f, 0.3f);</span>
<span class="nc" id="L588">			drawLines(rays);</span>
			// drawPoints(rayOrigins);

<span class="nc" id="L591">			glfwSwapBuffers(window);</span>
<span class="nc" id="L592">			glfwPollEvents();</span>
		}
<span class="nc" id="L594">	}</span>

	static void genOkData(int count, int numSites)
	{
<span class="nc" id="L598">		List&lt;List&lt;Vector&gt;&gt; res = new ArrayList&lt;&gt;();</span>

<span class="nc bnc" id="L600" title="All 2 branches missed.">		while (count &gt; 0)</span>
		{
<span class="nc" id="L602">			List&lt;Vector&gt; sites = genSites(numSites);</span>
			try
			{
<span class="nc" id="L605">				Validator valid = new Validator(sites, new Fortune(sites).processAll());</span>
<span class="nc bnc" id="L606" title="All 2 branches missed.">				if (valid.result())</span>
				{
<span class="nc" id="L608">					res.add(sites);</span>
<span class="nc" id="L609">					count--;</span>
				}
				else
				{
<span class="nc" id="L613">					System.out.println(&quot;Invalid result&quot;);</span>
				}
			}
<span class="nc" id="L616">			catch (Exception e)</span>
			{
<span class="nc" id="L618">				System.out.println(e);</span>
<span class="nc" id="L619">			}</span>
<span class="nc" id="L620">		}</span>

<span class="nc" id="L622">		FileHandler.write(Parse.toStringll(res), &quot;ok_data.txt&quot;);</span>
<span class="nc" id="L623">	}</span>

	static void genBadData(int count, int numSites)
	{
<span class="nc" id="L627">		List&lt;List&lt;Vector&gt;&gt; res = new ArrayList&lt;&gt;();</span>

<span class="nc bnc" id="L629" title="All 2 branches missed.">		while (count &gt; 0)</span>
		{
<span class="nc" id="L631">			List&lt;Vector&gt; sites = genSites(numSites);</span>
			try
			{
<span class="nc" id="L634">				Validator valid = new Validator(sites, new Fortune(sites).processAll());</span>
<span class="nc bnc" id="L635" title="All 2 branches missed.">				if (!valid.result())</span>
				{
<span class="nc" id="L637">					res.add(sites);</span>
<span class="nc" id="L638">					count--;</span>
				}

			}
<span class="nc" id="L642">			catch (Exception e)</span>
			{
<span class="nc" id="L644">				res.add(sites);</span>
<span class="nc" id="L645">				count--;</span>
<span class="nc" id="L646">			}</span>
<span class="nc" id="L647">		}</span>

<span class="nc" id="L649">		FileHandler.write(Parse.toStringll(res), &quot;bad_data.txt&quot;);</span>
<span class="nc" id="L650">	}</span>

	public static void main(String[] args)
	{
		App app;
<span class="nc bnc" id="L655" title="All 2 branches missed.">		if (args.length == 0)</span>
<span class="nc" id="L656">			app = new App();</span>
		else
		{
<span class="nc" id="L659">			String s = &quot;&quot;;</span>
<span class="nc bnc" id="L660" title="All 2 branches missed.">			for (int i = 0; i &lt; args.length; i++)</span>
<span class="nc" id="L661">				s += args[i] + &quot; &quot;;</span>
<span class="nc" id="L662">			app = new App(Parse.fromStringl(s));</span>
		}

<span class="nc" id="L665">		app.run();</span>
<span class="nc" id="L666">	}</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.7.202105040129</span></div></body></html>